#!/usr/bin/env python3
"""
Test d'installation complet avec Python 3.13 et MCP
"""

import sys
import os
import asyncio
import json
from datetime import datetime

# Ajouter le r√©pertoire src au path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))


async def test_python_version():
    """Test de la version Python"""
    version = sys.version_info
    print(f"‚úÖ Python {version.major}.{version.minor}.{version.micro}")
    
    if version >= (3, 10):
        print("‚úÖ Version Python compatible avec MCP")
        return True
    else:
        print("‚ùå Version Python trop ancienne pour MCP (requis: 3.10+)")
        return False


async def test_mcp_import():
    """Test d'import MCP"""
    try:
        import mcp
        from mcp.server import Server
        from mcp.types import Tool, TextContent
        print("‚úÖ MCP import√© avec succ√®s")
        print(f"   Version MCP disponible")
        return True
    except ImportError as e:
        print(f"‚ùå Erreur import MCP: {e}")
        print("üí° Installez avec: pip install mcp")
        return False


async def test_mqtt_client():
    """Test du client MQTT"""
    try:
        from iot_sensors_mcp.mqtt_client import MQTTClient, MQTTConfig, create_mqtt_client
        
        print("‚úÖ Client MQTT import√©")
        
        # Test de configuration
        config = MQTTConfig(host="localhost", port=1883)
        client = MQTTClient(config)
        
        print(f"‚úÖ Configuration: {config.host}:{config.port}")
        
        # Test des unit√©s UCUM
        ucum_count = sum(len(units) for units in client.ucum_units.values())
        print(f"‚úÖ {ucum_count} unit√©s UCUM support√©es")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå Erreur import client MQTT: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Erreur client MQTT: {e}")
        return False


async def test_server_mcp():
    """Test du serveur MCP"""
    try:
        from iot_sensors_mcp.server import app, mqtt_config
        
        print("‚úÖ Serveur MCP import√©")
        print(f"‚úÖ Configuration serveur: {mqtt_config.host}:{mqtt_config.port}")
        
        # Test de la liste des outils
        tools = await app.list_tools()
        print(f"‚úÖ {len(tools)} outils MCP disponibles:")
        for tool in tools:
            print(f"   ‚Ä¢ {tool.name}: {tool.description[:50]}...")
        
        # Test des ressources
        resources = await app.list_resources()
        print(f"‚úÖ {len(resources)} ressources MCP disponibles")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå Erreur import serveur MCP: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Erreur serveur MCP: {e}")
        return False


async def test_mqtt_connection():
    """Test de connexion MQTT"""
    try:
        from iot_sensors_mcp import create_mqtt_client
        
        print("\nüîó Test de connexion MQTT...")
        client = create_mqtt_client(client_id="test_installation_full")
        
        connected = await client.connect()
        
        if connected:
            print("‚úÖ Connexion MQTT r√©ussie!")
            
            # Test complet avec publication et abonnement
            await client.subscribe("test/installation/#")
            print("‚úÖ Abonnement r√©ussi")
            
            # Publier plusieurs types de capteurs
            sensors_data = [
                {"topic": "test/installation/temperature", "sensor_id": "temp_test", "value": 23.5, "unit": "Cel"},
                {"topic": "test/installation/humidity", "sensor_id": "hum_test", "value": 65.2, "unit": "%"},
                {"topic": "test/installation/pressure", "sensor_id": "press_test", "value": 1013.25, "unit": "hPa"}
            ]
            
            for sensor in sensors_data:
                success = await client.publish_sensor_data(**sensor)
                if success:
                    print(f"‚úÖ Publi√©: {sensor['sensor_id']} = {sensor['value']} {sensor['unit']}")
                else:
                    print(f"‚ùå √âchec publication: {sensor['sensor_id']}")
            
            # Attendre la r√©ception
            await asyncio.sleep(2)
            
            # V√©rifier l'historique
            total_messages = 0
            for sensor in sensors_data:
                history = client.get_message_history(sensor["topic"])
                total_messages += len(history)
                if history:
                    msg = history[-1]
                    print(f"üìú Dernier message {sensor['topic']}: {msg.payload[:50]}...")
            
            print(f"‚úÖ {total_messages} messages re√ßus et stock√©s")
            
            # Statut final
            status = client.get_status()
            print(f"üìä Statut: {status['subscribed_topics']} abonnements, {status['total_messages_stored']} messages")
            
            await client.disconnect()
            return True
            
        else:
            print("‚ö†Ô∏è Connexion MQTT √©chou√©e")
            print("üí° V√©rifiez que Mosquitto est d√©marr√©:")
            print("   brew services start mosquitto")
            return False
            
    except Exception as e:
        print(f"‚ùå Erreur test connexion: {e}")
        return False


async def test_claude_integration():
    """Test de l'int√©gration Claude Desktop"""
    try:
        # V√©rifier le fichier de configuration
        config_path = "claude_desktop_config.json"
        if os.path.exists(config_path):
            with open(config_path, 'r') as f:
                config = json.load(f)
            
            print("‚úÖ Configuration Claude Desktop trouv√©e")
            
            if "mcpServers" in config and "iot-sensors-mqtt" in config["mcpServers"]:
                server_config = config["mcpServers"]["iot-sensors-mqtt"]
                print(f"‚úÖ Serveur MCP configur√©: {server_config.get('command', 'N/A')}")
                print(f"‚úÖ R√©pertoire: {server_config.get('cwd', 'N/A')}")
                
                # V√©rifier les variables d'environnement
                env_vars = server_config.get("env", {})
                print(f"‚úÖ Variables d'environnement: {len(env_vars)} d√©finies")
                
                return True
            else:
                print("‚ùå Configuration serveur MCP manquante")
                return False
        else:
            print("‚ö†Ô∏è Fichier de configuration Claude Desktop non trouv√©")
            print("üí° Copiez claude_desktop_config.json dans votre configuration Claude")
            return False
            
    except Exception as e:
        print(f"‚ùå Erreur test int√©gration Claude: {e}")
        return False


async def main():
    """Test principal complet"""
    print("üß™ Test d'installation complet - IoT Sensors UCUM avec Python 3.13")
    print("=" * 70)
    print()
    
    # Tests s√©quentiels
    tests = [
        ("Version Python", test_python_version),
        ("Import MCP", test_mcp_import),
        ("Client MQTT", test_mqtt_client),
        ("Serveur MCP", test_server_mcp),
    ]
    
    results = {}
    
    for test_name, test_func in tests:
        print(f"\nüîç Test: {test_name}")
        print("-" * 30)
        try:
            results[test_name] = await test_func()
        except Exception as e:
            print(f"‚ùå Erreur inattendue: {e}")
            results[test_name] = False
    
    # Tests optionnels (d√©pendent de Mosquitto et configuration)
    optional_tests = [
        ("Connexion MQTT", test_mqtt_connection),
        ("Int√©gration Claude", test_claude_integration),
    ]
    
    for test_name, test_func in optional_tests:
        print(f"\nüîç Test optionnel: {test_name}")
        print("-" * 30)
        try:
            results[test_name] = await test_func()
        except Exception as e:
            print(f"‚ùå Erreur: {e}")
            results[test_name] = False
    
    # R√©sum√© final
    print("\n" + "=" * 70)
    print("üìã R√âSUM√â DES TESTS")
    print("=" * 70)
    
    core_tests = ["Version Python", "Import MCP", "Client MQTT", "Serveur MCP"]
    optional_tests_names = ["Connexion MQTT", "Int√©gration Claude"]
    
    core_passed = sum(1 for test in core_tests if results.get(test, False))
    optional_passed = sum(1 for test in optional_tests_names if results.get(test, False))
    
    print(f"\n‚úÖ Tests principaux: {core_passed}/{len(core_tests)} r√©ussis")
    print(f"‚úÖ Tests optionnels: {optional_passed}/{len(optional_tests_names)} r√©ussis")
    
    for test_name, passed in results.items():
        status = "‚úÖ R√âUSSI" if passed else "‚ùå √âCHEC"
        category = "[PRINCIPAL]" if test_name in core_tests else "[OPTIONNEL]"
        print(f"   {status} {category} {test_name}")
    
    # Recommandations
    print("\nüí° RECOMMANDATIONS")
    print("-" * 30)
    
    if core_passed == len(core_tests):
        print("üéâ Installation principale r√©ussie!")
        
        if not results.get("Connexion MQTT", False):
            print("üìã Pour activer MQTT:")
            print("   1. brew install mosquitto")
            print("   2. brew services start mosquitto")
            print("   3. Relancer ce test")
        
        if not results.get("Int√©gration Claude", False):
            print("üìã Pour activer Claude Desktop:")
            print("   1. Copier claude_desktop_config.json vers votre config Claude")
            print("   2. Red√©marrer Claude Desktop")
            print("   3. Tester avec: 'Quel est le statut de ma connexion MQTT?'")
        
        if results.get("Connexion MQTT", False) and results.get("Int√©gration Claude", False):
            print("üöÄ Installation compl√®te r√©ussie!")
            print("   Vous pouvez maintenant utiliser Claude avec MQTT pour vos projets IoT")
    
    else:
        print("‚ùå Installation incompl√®te - v√©rifiez les erreurs ci-dessus")
        print("üí° Relancez ./install_full.sh si n√©cessaire")
    
    return 0 if core_passed == len(core_tests) else 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
